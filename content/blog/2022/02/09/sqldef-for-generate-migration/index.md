---
title: sqldefをマイグレーションコード生成ツールとして使う
date: "2022-02-09T02:32:17.715Z"
update: "2022-02-09T02:32:17.715Z"
tags: ["sql"]
name: sqldef-for-generate-migration
lang: ja
otherLang: []
private: false
---

## はじめに
* マイグレーションコードは手書きしたくない
* しかしレビューした上でリポジトリにコミットしてそれを使いたい

prisma.jsのような感じです.
今回はpostgres+Rustのsqlxというライブラリで動くサンプルコードを作りましたが, 少しの修正で他のDBや言語でも使えます.

## sqldefとは
DDLを入力すると実際のDBのスキーマと比較し, DBのスキーマがDDLと等しくになるように `CREATE TABLE` や `ALTER TABLE` などのSQLを生成/実行してくれるツールです. SQLを入出力するコマンドラインツールなので言語やライブラリ関係なく使えます. 詳しくはリポジトリや作者のブログを見てください.


## 
sqldefは `-f` オプションを2回指定することができ, こうすると1個目のDDLは目標スキーマ, 2個目のDDLファイルは現在のDDLとなります. DBに接続してスキーマをダンプする代わりにファイルから取ってくることができます(当然自動的にdry runになります). これを使ってupファイルとdownファイルを `-f` の順番を変えることで生成します.

### ちょっとした加工
行頭コメントの削除とマイグレーションテーブルの削除.
`Run: '...'` みたいなのはREADMEには出ると書いてありますが実際に実行すると出ませんでした.
